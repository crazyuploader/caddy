name: CI

on:
  push:
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Run GoReleaser (Snapshot)
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --snapshot --clean --skip=publish,docker,sign

      - name: Verify Builds
        run: |
          # Find the linux build
          CADDY_BIN=$(find dist -name caddy -type f | grep linux_amd64 | head -n 1)
          if [ -z "$CADDY_BIN" ]; then
            echo "::error::Could not find built binary"
            exit 1
          fi

          chmod +x "$CADDY_BIN"
          echo "Verifying binary: $CADDY_BIN"

          # Check version
          "$CADDY_BIN" version

          # Check modules
          MODULES=$("$CADDY_BIN" list-modules)

          REQUIRED=("dns.providers.cloudflare" "caddy.storage.redis" "caddy.storage.postgres" "caddy.storage.cloudflare_kv" "http.encoders.br" "http.handlers.rate_limit" "layer4")

          for mod in "${REQUIRED[@]}"; do
            if echo "$MODULES" | grep -q "$mod"; then
              echo "âœ… Plugin found: $mod"
            else
              echo "::error::Missing plugin: $mod"
              exit 1
            fi
          done
