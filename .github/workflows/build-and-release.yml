name: Build and Release Custom Caddy Web Server

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      caddy_version:
        description: "Caddy version to build"
        required: false
        default: "latest"

permissions:
  contents: read

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    strategy:
      matrix:
        include:
          - arch: amd64
            goarch: amd64
          - arch: arm64
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "~1.25.6"
          check-latest: true

      - name: Set up QEMU for cross-compilation
        if: matrix.goarch == 'arm64'
        uses: docker/setup-qemu-action@v3

      - name: Install QEMU user-static for ARM64
        if: matrix.goarch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static

      - name: Get version info
        id: vars
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG=${GITHUB_REF#refs/tags/}
          else
            if [ "${{ github.event.inputs.caddy_version }}" == "latest" ] || [ -z "${{ github.event.inputs.caddy_version }}" ]; then
              TAG="latest"
            else
              TAG="${{ github.event.inputs.caddy_version }}"
            fi
          fi

          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "Building Caddy ${TAG} for ${{ matrix.arch }}"

      - name: Install xcaddy
        run: |
          go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
          xcaddy version

      - name: Install nfpm
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt update
          sudo apt install -y nfpm

      - name: Build Caddy with custom plugins
        env:
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          mkdir -p caddy-build

          xcaddy build ${{ steps.vars.outputs.TAG }} \
            --output ./caddy-build/caddy \
            --with github.com/caddy-dns/cloudflare \
            --with github.com/pberkel/caddy-storage-redis \
            --with github.com/yroc92/postgres-storage \
            --with github.com/mentimeter/caddy-storage-cf-kv \
            --with github.com/ueffel/caddy-brotli

          chmod +x ./caddy-build/caddy

      - name: Get actual Caddy version
        id: caddy_version
        run: |
          if [ "${{ matrix.goarch }}" = "amd64" ]; then
            CADDY_CMD="./caddy-build/caddy"
          else
            CADDY_CMD="qemu-aarch64-static ./caddy-build/caddy"
          fi

          ACTUAL_VERSION=$($CADDY_CMD version | head -n1 | awk '{print $1}' | sed 's/^v//')

          if [ "$ACTUAL_VERSION" = "latest" ] || [ -z "$ACTUAL_VERSION" ]; then
            ACTUAL_VERSION="0.0.0+$(date -u +%Y%m%d.%H%M)"
          fi

          echo "PKG_VERSION=${ACTUAL_VERSION}" >> $GITHUB_OUTPUT
          echo "Package version: ${ACTUAL_VERSION}"

      - name: List modules
        run: |
          if [ "${{ matrix.goarch }}" = "amd64" ]; then
            ./caddy-build/caddy list-modules | grep -E '(dns.providers.cloudflare|caddy.storage.redis|caddy.storage.postgres|caddy.storage.cloudflare_kv|http.encoders.br)'
          else
            qemu-aarch64-static ./caddy-build/caddy list-modules | grep -E '(dns.providers.cloudflare|caddy.storage.redis|caddy.storage.postgres|caddy.storage.cloudflare_kv|http.encoders.br)'
          fi

      - name: Generate man pages and completions
        run: |
          mkdir -p caddy-dist/man caddy-dist/scripts

          if [ "${{ matrix.goarch }}" = "amd64" ]; then
            ./caddy-build/caddy manpage --directory ./caddy-dist/man
            ./caddy-build/caddy completion bash > ./caddy-dist/scripts/bash-completion
          else
            qemu-aarch64-static ./caddy-build/caddy manpage --directory ./caddy-dist/man
            qemu-aarch64-static ./caddy-build/caddy completion bash > ./caddy-dist/scripts/bash-completion
          fi

          gzip -r ./caddy-dist/man/

      - name: Create package files
        run: |
          mkdir -p systemd
          cp -r caddy-dist systemd ./caddy-build/

      - name: Build .deb package
        env:
          VERSION: ${{ steps.caddy_version.outputs.PKG_VERSION }}
          ARCH: ${{ matrix.arch }}
        run: |
          nfpm pkg --packager deb --target ./

          DEB_FILE=$(ls caddy_*.deb)
          NEW_NAME="caddy_${VERSION}_linux_${ARCH}.deb"
          mv "$DEB_FILE" "$NEW_NAME"

          echo "Created: $NEW_NAME"
          dpkg-deb --info "$NEW_NAME"
          dpkg-deb --contents "$NEW_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: caddy-${{ matrix.arch }}-deb
          path: "caddy_*.deb"
          retention-days: 5

  publish-apt-repo:
    name: Publish APT Repository
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./debs

      - name: Prepare packages
        run: |
          mkdir -p packages
          find ./debs -name "*.deb" -exec cp {} ./packages/ \;
          ls -lh ./packages/

      - name: Setup GPG
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import

          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf

          gpg-connect-agent reloadagent /bye || true
          gpg --list-secret-keys --keyid-format=long

      - name: Create APT repository with aptly
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          sudo apt-get update
          sudo apt-get install -y aptly

          cat > ~/.aptly.conf << EOF
          {
            "gpgProvider": "gpg",
            "gpgDisableSign": false,
            "gpgDisableVerify": false
          }
          EOF

          aptly repo create -distribution=stable -component=main caddy-custom
          aptly repo add caddy-custom ./packages/*.deb

          echo "$GPG_PASSPHRASE" > /tmp/gpg-pass

          aptly publish repo \
            -batch \
            -architectures="amd64,arm64" \
            -gpg-key="${{ secrets.GPG_KEY_ID }}" \
            -passphrase-file=/tmp/gpg-pass \
            caddy-custom

          rm -f /tmp/gpg-pass

          mkdir -p public
          cp -r ~/.aptly/public/* public/
          gpg --armor --export ${{ secrets.GPG_KEY_ID }} > public/public.key
          cp ./scripts/migrate.sh public/migrate.sh
          cp ./public/index.html public/index.html

          cat > public/README.md << 'EOF'
          # Custom Caddy APT Repository

          ## Quick Install

          ```bash
          curl -fsSL https://caddy.devjugal.com/public.key | sudo gpg --dearmor -o /usr/share/keyrings/caddy-custom.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/caddy-custom.gpg] https://caddy.devjugal.com stable main" | sudo tee /etc/apt/sources.list.d/caddy-custom.list
          sudo apt update && sudo apt install caddy
          ```

          ## Migrate from Official Caddy

          ```bash
          curl -fsSL https://caddy.devjugal.com/migrate.sh | sudo bash
          ```

          ## Included Plugins

          - dns.providers.cloudflare
          - caddy.storage.redis
          - caddy.storage.postgres
          - caddy.storage.cloudflare_kv
          - http.encoders.br

          [View Documentation](https://caddy.devjugal.com)
          EOF

      - name: Push to cf-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: cf-pages
          force_orphan: true

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ./packages/*.deb
          body: |
            ## Custom Caddy Build

            ### Included Plugins
            - dns.providers.cloudflare
            - caddy.storage.redis
            - caddy.storage.postgres
            - caddy.storage.cloudflare_kv
            - http.encoders.br

            ### Installation via APT
            See [installation instructions](https://caddy.devjugal.com)
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
